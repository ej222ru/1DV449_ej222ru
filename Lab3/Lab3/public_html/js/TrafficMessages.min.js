"use strict";function parseJsonDate(e){var t=new Date(parseInt(e.replace("/Date(","")));return t.toLocaleString("sv-SE")}function parseJsonDateToInt(e){return parseInt(e.replace("/Date(",""))}function toggleButton(e){var t=e.replace("b","t"),a=e.substring(1),r=document.getElementById(t);"Hide"===r.className?(r.setAttribute("class","Show"),toggleBounce(markers[a])):(r.setAttribute("class","Hide"),toggleBounce(markers[a]))}function renderTrafficMessages(e){var t="";t=e;var a,r=document.getElementById("trafficMessages"),n=0;for(r.innerHTML="<h2>Trafikmeddelanden</h2>",deleteMarkers(),a=0;a<t.length;a++)if(checkCategory(t[a].subcategory)){var s=parseJsonDate(t[a].createddate),o={lat:t[a].latitude,lng:t[a].longitude},c=t[a].title,d="<b>"+t[a].subcategory+"   "+s+"</b></br>";d+=t[a].description+"</br>"+t[a].exactlocation,addMarker(o,map,c,d);var i=document.createElement("DIV");i.setAttribute("class","Message");var c=document.createTextNode(t[a].title);i.appendChild(c);var l=document.createElement("BUTTON"),g="b"+n;l.setAttribute("id",g),l.onclick=function(){toggleButton(this.id)};var u=document.createTextNode("Info");l.appendChild(u);var m=document.createElement("DIV");m.innerHTML=s;var f=document.createElement("DIV");f.innerHTML=t[a].subcategory,f.setAttribute("class","Subcategory");var p=document.createTextNode(t[a].description),T=document.createTextNode(t[a].exactlocation);m.appendChild(f),m.appendChild(p),m.appendChild(T),m.setAttribute("class","Hide"),g="t"+n,m.setAttribute("id",g),i.appendChild(l),i.appendChild(m),r.appendChild(i),n++}}function attachCheckboxHandlers(){for(var e=document.getElementById("categoryForm"),t=e.getElementsByTagName("input"),a=0,r=t.length;r>a;a++)"checkbox"===t[a].type&&(t[a].onclick=renderTrafficMessages)}function checkCategory(e){var t;return t="Halkvarning"===e?document.getElementsByName("Halkvarning")[0].checked:"Trafikolycka"===e?document.getElementsByName("Trafikolycka")[0].checked:"Trafikstörning"===e?document.getElementsByName("Trafikstörning")[0].checked:"Vägarbete"===e?document.getElementsByName("Vägarbete")[0].checked:document.getElementsByName("Övrigt")[0].checked}function TrafficMessages(e){var t,a="",r=new XMLHttpRequest,n=(document.getElementById("trafficMessages"),new Date),s=n.getTime();r.onreadystatechange=function(){4==r.readyState&&200==r.status&&(localStorage.response=r.responseText,localStorage.setItem("lastDataRead",s),t=JSON.parse(r.responseText),a=t.messages,a.sort(sort_by("createddate",!0,function(e){return parseJsonDateToInt(e)})),renderTrafficMessages(a))};var o=(localStorage.getItem("lastDataRead"),s-localStorage.getItem("lastDataRead")-6e4);null===localStorage.response||null===localStorage.getItem("lastDataRead")||o>0?(console.log("read from SR    now:"+s+"---last read from SR:"+localStorage.getItem("lastDataRead")+"  diff:"+o),r.open("GET",e,!0),r.send()):(console.log("read from cache   now:"+s+"---last read from SR:"+localStorage.getItem("lastDataRead")+"  diff:"+o),t=JSON.parse(localStorage.response),a=t.messages,a.sort(sort_by("createddate",!0,function(e){return parseJsonDateToInt(e)})),renderTrafficMessages(a))}var map,sort_by=function(e,t,a){var r=a?function(t){return a(t[e])}:function(t){return t[e]};return t=t?-1:1,function(e,a){return e=r(e),a=r(a),t*((e>a)-(a>e))}},myTrafficMessages={init:function(e){map=initMap();new TrafficMessages(e);attachCheckboxHandlers()}};window.addEventListener("load",myTrafficMessages.init("http://api.sr.se/api/v2/traffic/messages?format=json&size=200"));