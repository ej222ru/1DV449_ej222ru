"use strict";function renderPoliceReports(){function e(e,t,a,n){for(var r=0,o=0;a>o;o++)if(parseFloat(e[o].childNodes[0].nodeValue)==parseFloat(e[a].childNodes[0].nodeValue)&&parseFloat(t[o].childNodes[0].nodeValue)==parseFloat(t[a].childNodes[0].nodeValue)){r++;var l=parseFloat(e[a].childNodes[0].nodeValue)+.01*r,i=parseFloat(t[a].childNodes[0].nodeValue)+.01*r;n={lat:l,lng:i}}return n}var t=[];if(1==document.getElementById("policeReportsCheckBox").checked){if(localStorage.displayPoliceReports="Show",getPoliceReports(),void 0!=localStorage.policeReports){var a=jQuery.parseXML(localStorage.policeReports);if(a)for(var n=a.getElementsByTagName("lat"),r=a.getElementsByTagName("lng"),o=a.getElementsByTagName("description"),l=a.getElementsByTagName("place"),i=a.getElementsByTagName("text"),s=a.getElementsByTagName("event"),c=0;c<s.length;c++){var d=[],g={lat:parseFloat(n[c].childNodes[0].nodeValue),lng:parseFloat(r[c].childNodes[0].nodeValue)};g=e(n,r,c,g),d.pos=g,d.header=o[c].childNodes[0].nodeValue,d.descript=l[c].childNodes[0].nodeValue,d.text=i[c].childNodes[0].nodeValue,t.push(d)}for(var c=0;c<t.length;c++){var g=t[c].pos,u=t[c].header,m="<b>"+t[c].descript+"</br></b>"+t[c].text;addMarker(g,map,u,m,"policeReports")}}}else localStorage.displayPoliceReports="Hide",clearMarkers(),markRegionOnMap()}function attachCrimeCheckboxHandler(){var e=document.getElementById("crimeForm"),t=e.getElementsByTagName("input");"checkbox"===t[0].type&&(t[0].onclick=renderPoliceReports)}function getPoliceReports(){var e=new Date,t=e.getTime(),a=localStorage.getItem("lastDataRead"),n=t-a-6e4;if(null===localStorage.policeReports||null===a||n>0){console.log("read from brottsstatistik now:"+t+"---last read from brottsstatistik:"+a+"  diff:"+n);var r="&Crime=true";$.ajax({url:"index.php",type:"POST",async:!1,data:r,datatype:"text",success:function(e,a,n){localStorage.policeReports=e,localStorage.lastDataRead=t},error:function(e,t,a){}})}else console.log("read from cache   now:"+t+"---last read from brottsstatistik:"+localStorage.getItem("lastDataRead")+"  diff:"+n)}function setupRegionSelectBox(){$(document).ready(function(){$("#RegionId").multiselect({buttonText:function(e,t){if(0===e.length)return"Välj kommuner ";if(e.length>3){var a=$("#RegionId option").filter(function(){return!$(this).is(":selected")});a.each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!0),e.parent("li").addClass("disabled")})}else $("#RegionId option").each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!1),e.parent("li").addClass("disabled")});var n=[];return e.each(function(){void 0!==$(this).attr("label")?n.push($(this).attr("label")):n.push($(this).html())}),n.join(", ")+""}})})}function setupCriteriaSelectBox(){$(document).ready(function(){$("#CriteriaId").multiselect({buttonText:function(e,t){if(0===e.length)return"Välj jämförelsetal ";if(e.length>3){var a=$("#CriteriaId option").filter(function(){return!$(this).is(":selected")});a.each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!0),e.parent("li").addClass("disabled")})}else $("#CriteriaId option").each(function(){var e=$('input[value="'+$(this).val()+'"]');e.prop("disabled",!1),e.parent("li").addClass("disabled")});var n=[];return e.each(function(){void 0!==$(this).attr("label")?n.push($(this).attr("label")):n.push($(this).html())}),n.join(", ")+""}})})}function getItem(e,t){var a=document.getElementsByName("Region[]"),n=document.getElementsByName("Criteria[]"),r="",o=0;if("Region"==e)for(var l=0;l<a[0].childElementCount;l++)a[0][l].selected&&(o++,o==t&&(r=a[0][l].value));else if("Criteria"==e)for(var l=0;l<n[0].childElementCount;l++)n[0][l].selected&&(o++,o==t&&(r=n[0][l].value));return r}function getSelectedItems(e){var t=document.getElementsByName("Region[]"),a=document.getElementsByName("Criteria[]"),n=0;if("Region"==e)for(var r=0;r<t[0].childElementCount;r++)t[0][r].selected&&n++;else if("Criteria"==e)for(var r=0;r<a[0].childElementCount;r++)a[0][r].selected&&n++;return n}function getBarChartTypeInfo(e,t){var a="";return"Region"==e?t<=getSelectedItems("Region")&&(a=getItem("Region",t)):"Criteria"==e&&t<=getSelectedItems("Criteria")&&(a=getItem("Criteria",t)),a}function getBarChartLabels(e){var t="";return t=2*(e+1)-getSelectedItems("Criteria")==1?[getBarChartTypeInfo("Criteria",1+2*e)]:[getBarChartTypeInfo("Criteria",1+2*e),getBarChartTypeInfo("Criteria",2+2*e)]}function getBarChartYAxis(e){return e%2==1?"y-axis-1":"y-axis-2"}function getBarChartColor(e){return 1==e?"rgba(255,0,0,0.5)":2==e?"rgba(86,66,232,0.5)":3==e?"rgba(20,255,0,0.5)":void 0}function getBarChartValue(e,t){var a="";return e<=getSelectedItems("Region")&&t<=getSelectedItems("Criteria")&&(a=t%2==1?[localStorage[getItem("Region",e)+getItem("Criteria",t)],0]:[0,localStorage[getItem("Region",e)+getItem("Criteria",t)]]),a}function setupChartDataset(e,t){return{label:getBarChartTypeInfo("Region",e),backgroundColor:getBarChartColor(e),yAxisID:getBarChartYAxis(t),data:getBarChartValue(e,t)}}function setupBarChart(){document.getElementById("chartContainer").innerHTML="&nbsp;",document.getElementById("chartContainer").innerHTML='<canvas id="myChart1"></canvas><canvas id="myChart2"></canvas>';for(var e=getSelectedItems("Criteria")/2,t=0;e>t;t++){var a,n=1+2*t,r=2+2*t,o={labels:getBarChartLabels(t),datasets:[setupChartDataset(1,n),setupChartDataset(2,n),setupChartDataset(3,n),setupChartDataset(4,n),setupChartDataset(1,r),setupChartDataset(2,r),setupChartDataset(3,r),setupChartDataset(4,r)]};a=0==t?document.getElementById("myChart1").getContext("2d"):document.getElementById("myChart2").getContext("2d");var l;l=2*(t+1)-getSelectedItems("Criteria")==1?{yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1"}]}:{yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1"},{type:"linear",display:!0,position:"right",id:"y-axis-2",gridLines:{drawOnChartArea:!1}}]},Chart.Bar(a,{data:o,options:{responsive:!0,hoverMode:"label",hoverAnimationDuration:400,stacked:!1,scales:l}})}}function getRegionPosition(e){var t;switch(e){case"Botkyrka":t={lat:59.23,lng:17.82};break;case"Danderyd":t={lat:59.4,lng:18.07};break;case"Ekerö":t={lat:59.3,lng:17.85};break;case"Haninge":t={lat:59.1,lng:18.2};break;case"Huddinge":t={lat:59.23,lng:18};break;case"Järfälla":t={lat:59.43,lng:17.8};break;case"Nacka":t={lat:59.3,lng:18.25};break;case"Sollentuna":t={lat:59.43,lng:17.91};break;case"Solna":t={lat:59.36,lng:17.98};break;case"Stockholm":t={lat:59.325,lng:18.1};break;case"Sundbyberg":t={lat:59.368,lng:17.95};break;case"Tyresö":t={lat:59.245,lng:18.25};break;case"Täby":t={lat:59.44,lng:18.07};break;case"Upplands Väsby":t={lat:59.51,lng:17.925};break;case"Vallentuna":t={lat:59.5,lng:18.1};break;case"Värmdö":t={lat:59.3,lng:18.43};break;case"Österåker":t={lat:59.46,lng:18.35}}return t}function calcCenterPosition(e){for(var t=0,a=0,n=0,r=0,o="",l=function(e){void 0!=e&&(t+=e.lat,a+=e.lng,n++)},i=0;i<e.length;i++)l(e[i]);if(0!=n){var t=t/n,a=a/n;r='{ "lat":'+t+',"lng":'+a+"}",o=JSON.parse(r)}return o}function markRegionOnMap(){for(var e=[],t=[],a=1;a<=getSelectedItems("Region");a++)e.push(getBarChartTypeInfo("Region",a)),t.push(getRegionPosition(e[a-1])),addMarker(t[a-1],map,e[a-1],"","region");var n=calcCenterPosition(t);""!=n&&map.setCenter(n)}function refreshLocalStorage(){for(var e=document.getElementsByName("Region[]"),t=document.getElementsByName("Criteria[]"),a=0;a<t[0].childElementCount;a++)for(var n=0;n<e[0].childElementCount;n++)localStorage.clear(e[0][n].value+t[0][a].value)}function displayInfo(){var e=document.getElementById("displayInfo"),t=document.getElementById("Info");"Hide"==t.className?(t.className="Show",e.innerHTML="Stäng info"):(t.className="Hide",e.innerHTML="Info")}function getSCBData(){var e="",t=document.getElementsByName("Region[]"),a=document.getElementsByName("Criteria[]");if(0==getSelectedItems("Region")||0==getSelectedItems("Criteria"))document.getElementById("chartContainer").className="Hide",document.getElementById("error").className="Show",document.getElementById("error").innerHTML="Du måste välja minst en kommun och ett jämförelsetal";else{for(var n=0;n<t[0].childElementCount;n++)if(t[0][n].selected)for(var r=0;r<a[0].childElementCount;r++)if(e="",a[0][r].selected){var o=localStorage[t[0][n].value+a[0][r].value];void 0!=o?console.log("SCBData from localStorage region:"+t[0][n].value+" criteria:"+a[0][r].value):(console.log("SCBData from server region:"+t[0][n].value+" criteria:"+a[0][r].value),e+="&",e+="Region[]=",e+=t[0][n].value,e+="&",e+="Criteria[]=",e+=a[0][r].value,$.ajax({url:"index.php",type:"POST",async:!1,data:e,success:function(e,t,a){var n=JSON.parse(e);if("true"==n.error){localStorage.removeItem("response");var r=n.errorText;document.getElementById("error").innerHTML=r,document.getElementById("error").className="Show"}else{localStorage.response="true";var n=JSON.parse(e);localStorage[n.Region+n.Criteria]=n.Value}},error:function(e,t,a){localStorage.removeItem("response")}}))}document.getElementById("chartContainer").className="Show",document.getElementById("error").className="Hide"}myRegionInfo.init()}function initMap(){var e={lat:59.35,lng:18.1};return map=new google.maps.Map(document.getElementById("map"),{center:e,zoom:10})}function addMarker(e,t,a,n,r){var o="https://maps.google.com/mapfiles/kml/",l="paddle/R.png";"policeReports"==r&&(l="shapes/police.png");var i='<div id="content"><div id="siteNotice"></div><h1 id="firstHeading" class="firstHeading">'+a+'</h1><div id="bodyContent">'+n+"</div></div>",s=new google.maps.InfoWindow({content:i}),c=new google.maps.Marker({position:e,map:t,title:a,icon:o+l});markers.push(c),c.addListener("click",function(){""!=openInfoWindow&&openInfoWindow.close(),s.open(t,c),openInfoWindow=s}),c.setAnimation(null)}function setMapOnAll(e){for(var t=0;t<markers.length;t++)markers[t].setMap(e)}function clearMarkers(){setMapOnAll(null)}function showMarkers(){setMapOnAll(map)}function deleteMarkers(){clearMarkers(),markers=[]}function toggleBounce(e){null!==e.getAnimation()?e.setAnimation(null):e.setAnimation(google.maps.Animation.BOUNCE)}var map,myRegionInfo={init:function(e){document.getElementById("getSCB").addEventListener("click",getSCBData),document.getElementById("displayInfo").addEventListener("click",displayInfo),document.getElementById("refreshLocalStorage").addEventListener("click",refreshLocalStorage),setupRegionSelectBox(),setupCriteriaSelectBox();var t=localStorage.response;void 0===t?document.getElementById("chartContainer").className="Hide":setupBarChart(),map=initMap(),"Show"==document.getElementById("chartContainer").className&&markRegionOnMap(),attachCrimeCheckboxHandler()}};window.addEventListener("load",myRegionInfo.init());var markers=[],openInfoWindow="";